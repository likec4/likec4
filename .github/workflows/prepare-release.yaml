name: prepare release

on:
  pull_request_target:
    branches:
      - "main"
    paths:
      - ".github/workflows/prepare-release.yaml"
      - "**/package.json"

permissions:
  id-token: write
  contents: write

env:
  NODE_ENV: production
  CLOUDFLARE_ENV: production
  FORCE_COLOR: true
  DO_NOT_TRACK: "1"

jobs:
  prepare-release:
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 5
    if: "github.repository_owner == 'likec4' && startsWith(github.head_ref, 'changeset-release/')"
    steps:
      # - name: Decode the GitHub App Private Key
      #   id: decode
      #   run: |
      #     private_key=$(echo "${{ secrets.BOT_APP_PRIVATE_KEY }}" | base64 -d | awk 'BEGIN {ORS="\\n"} {print}' | head -c -2) &> /dev/null
      #     echo "::add-mask::$private_key"
      #     echo "private-key=$private_key" >> "$GITHUB_OUTPUT"

      # - uses: actions/create-github-app-token@v2
      #   id: app-token
      #   with:
      #     app-id: ${{ secrets.BOT_APP_ID }}
      #     private-key: ${{ steps.decode.outputs.private-key }}
      - uses: actions/checkout@v6
        with:
          # token: ${{ steps.app-token.outputs.token }}
          fetch-depth: 0
          ref: ${{ github.head_ref }}

      # - name: Get GitHub App User ID
      #   id: get-user-id
      #   run: echo "user-id=$(gh api "/users/${{ steps.app-token.outputs.app-slug }}[bot]" --jq .id)" >> "$GITHUB_OUTPUT"
      #   env:
      #     GH_TOKEN: ${{ steps.app-token.outputs.token }}

      # - run: |
      #     git config --global user.name '${{ steps.app-token.outputs.app-slug }}[bot]'
      #     git config --global user.email '${{ steps.get-user-id.outputs.user-id }}+${{ steps.app-token.outputs.app-slug }}[bot]@users.noreply.github.com'

      - name: üõ†Ô∏è bootstrap
        uses: ./.github/actions/bootstrap

      - name: update version
        run: pnpm likec4ops sync-version

      - uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: "chore: sync version"
