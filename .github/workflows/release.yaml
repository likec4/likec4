name: release

on:
  workflow_call:
  workflow_dispatch:

permissions:
  id-token: write # Required for NPM Trusted publishing
  actions: write
  checks: write
  contents: write
  statuses: write

env:
  NODE_ENV: production
  CLOUDFLARE_ENV: production
  FORCE_COLOR: true
  DO_NOT_TRACK: "1"

jobs:
  publish:
    name: ğŸ“¦ npm
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 5
    if: ${{ github.repository_owner == 'likec4' }}
    environment: release
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: ğŸ› ï¸ bootstrap
        uses: ./.github/actions/bootstrap

      - name: âš™ï¸ build
        run: pnpm ci:build

      - name: ğŸ“¦ publish
        run: pnpm ci:publish

  vscode:
    name: ğŸ“¦ vscode
    uses: ./.github/workflows/vscode.yaml
    if: ${{ github.repository_owner == 'likec4' }}
    secrets: inherit
