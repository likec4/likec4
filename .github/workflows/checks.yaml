name: checks

on:
  workflow_call:

env:
  NODE_ENV: production
  CLOUDFLARE_ENV: "production"
  FORCE_COLOR: true
  DO_NOT_TRACK: "1"

jobs:
  check-types:
    name: Ê¦ typescript
    timeout-minutes: 5
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6

      - name: ðŸ› ï¸ bootstrap
        uses: ./.github/actions/bootstrap

      - name: Ê¦ typecheck
        run: pnpm ci:typecheck

      - name: ðŸ”¬ type tests
        working-directory: packages/core
        run: pnpm test --typecheck

      # TODO: Here it says to run lint after typecheck
      # https://oxc.rs/docs/guide/usage/linter/type-aware.html#monorepos-and-build-outputs
      - name: ðŸ§¹ lint
        run: pnpm ci:lint

  check-build:
    name: ðŸ› ï¸ build
    timeout-minutes: 5
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6

      - name: ðŸ› ï¸ bootstrap
        uses: ./.github/actions/bootstrap

      - name: âš™ï¸ build
        run: pnpm ci:build

      - name: âš™ï¸ lint:package
        run: |
          pnpm lint:package

      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: tarballs
          compression-level: 0
          path: |
            packages/*/package.tgz
          if-no-files-found: error

  check-on-windows:
    name: âŠž windows build
    timeout-minutes: 20
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v6

      - name: ðŸ› ï¸ bootstrap
        uses: ./.github/actions/bootstrap

      # TODO: fix obuild on windows
      # - name: âš™ï¸ build
      #   run: pnpm turbo run build --filter="likec4"

      - name: âš™ï¸ generate
        run: pnpm ci:generate

      - name: ðŸ”¬ test
        env:
          NODE_ENV: test
        run: pnpm ci:test

  check-tests:
    name: ðŸ”¬ tests
    timeout-minutes: 5
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6

      - name: ðŸ› ï¸ bootstrap
        uses: ./.github/actions/bootstrap

      - name: âš™ï¸ generate
        run: pnpm generate

      - name: ðŸ”¬ test
        env:
          NODE_ENV: test
        run: pnpm ci:test

  check-docs-astro:
    name: ðŸ“– docs
    timeout-minutes: 5
    runs-on: ubuntu-24.04
    needs:
      - check-build
      - check-types
      - check-tests
    steps:
      - uses: actions/checkout@v6

      - name: ðŸ› ï¸ bootstrap
        uses: ./.github/actions/bootstrap

      - name: Ê¦ typecheck
        run: |
          pnpm turbo run typecheck --filter='@likec4/docs-astro'

      - name: âš™ï¸ build
        run: |
          pnpm turbo run build --filter='@likec4/docs-astro'

  check-playground:
    name: ðŸŽ® playground
    timeout-minutes: 5
    runs-on: ubuntu-24.04
    needs:
      - check-build
      - check-types
      - check-tests
    steps:
      - uses: actions/checkout@v6

      - name: ðŸ› ï¸ bootstrap
        uses: ./.github/actions/bootstrap

      - name: Ê¦ typecheck
        run: |
          pnpm turbo run typecheck --filter='@likec4/playground'

      - name: âš™ï¸ build
        run: |
          pnpm turbo run build --filter='@likec4/playground'

  check-e2e-tests:
    name: ðŸ”¬ e2e tests
    timeout-minutes: 10
    runs-on: ubuntu-24.04
    needs:
      - check-build
      - check-types
      - check-tests
    steps:
      - uses: actions/checkout@v6

      - name: ðŸ› ï¸ Setup pnpm
        uses: pnpm/action-setup@v4
        env:
          NODE_ENV: development

      - name: ðŸ› ï¸ Setup node
        uses: actions/setup-node@v6
        with:
          node-version-file: .tool-versions
          cache: "pnpm"

      - name: ðŸ“¦ download tarballs
        uses: actions/download-artifact@v7
        with:
          name: tarballs
          path: packages

      - name: ðŸ› ï¸ install e2e dependencies
        working-directory: e2e
        run: |
          pnpm install
          pnpm add \
            ../packages/core/package.tgz \
            ../packages/icons/package.tgz \
            ../packages/likec4/package.tgz
          pnpm install:chromium
          pnpm bootstrap

      - name: âš™ï¸ run playwright tests
        working-directory: e2e
        run: pnpm test

      - id: cloudflare
        if: ${{ failure() && github.repository_owner == 'likec4' }}
        name: âš™ï¸ publish playwright-report
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy playwright-report --project-name likec4-e2e --commit-dirty --branch preview
          workingDirectory: e2e
          packageManager: pnpm

      - name: print url to published report
        if: ${{ failure() && github.repository_owner == 'likec4' }}
        run: |
          echo "::warning::Report published at ${{ steps.cloudflare.outputs.deployment-url }}"

      - uses: actions/upload-artifact@v6
        if: ${{ !cancelled() }}
        with:
          name: playwright-report
          path: e2e/playwright-report/
          compression-level: 9
          retention-days: 5

  check-e2e-types:
    name: ðŸ”¬ e2e types
    timeout-minutes: 10
    runs-on: ubuntu-24.04
    needs:
      - check-build
      - check-types
      - check-tests
    steps:
      - uses: actions/checkout@v6

      - name: ðŸ› ï¸ Setup pnpm
        uses: pnpm/action-setup@v4
        env:
          NODE_ENV: development

      - name: ðŸ› ï¸ Setup node
        uses: actions/setup-node@v6
        with:
          node-version-file: .tool-versions
          cache: "pnpm"

      - name: ðŸ“¦ download tarballs
        uses: actions/download-artifact@v7
        with:
          name: tarballs
          path: packages

      - name: ðŸ› ï¸ install e2e dependencies
        working-directory: e2e
        run: |
          pnpm install
          pnpm add \
            ../packages/core/package.tgz \
            ../packages/icons/package.tgz \
            ../packages/likec4/package.tgz
          pnpm bootstrap

      - name: Ê¦ typecheck test
        working-directory: e2e
        run: pnpm typecheck

      - uses: actions/upload-artifact@v6
        if: ${{ failure() }}
        with:
          name: generated-e2e-types
          path: e2e/src/*.ts
          compression-level: 9
          retention-days: 5

  # This job depends on all the previous jobs to ensure the quality gate
  check-quality-gate:
    name: ðŸš¦ quality gate
    runs-on: ubuntu-24.04
    needs:
      - check-types
      - check-build
      - check-on-windows
      - check-tests
      - check-docs-astro
      - check-playground
      - check-e2e-tests
      - check-e2e-types
    steps:
      - run: |
          echo "### Quality Gate Passed :rocket:" >> $GITHUB_STEP_SUMMARY
