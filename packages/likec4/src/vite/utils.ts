import { rootLogger } from '@likec4/log'
import { existsSync } from 'node:fs'
import { mkdtemp, writeFile } from 'node:fs/promises'
import { tmpdir } from 'node:os'
import { dirname, join, relative, resolve } from 'node:path'
import { cwd } from 'node:process'
import { fileURLToPath } from 'node:url'
import { packageUpSync } from 'package-up'
import { find } from 'remeda'
import { createLikeC4Logger } from '../logger'

export const viteLogger = createLikeC4Logger('vite')

const _dirname = dirname(fileURLToPath(import.meta.url))

const banner = `
/* prettier-ignore-start */
/* eslint-disable */

/******************************************************************************
 * This file was generated
 * DO NOT EDIT MANUALLY!
 ******************************************************************************/

`.trimStart()

const footer = `

/* prettier-ignore-end */
`

export const JsBanners = {
  banner,
  footer,
}

/** Resolves the likec4 package root by walking up from current file. */
export function findPkgRoot() {
  const pkgRoot = packageUpSync({
    cwd: _dirname,
  })
  if (!pkgRoot) {
    throw new Error(`likec4 package folder not found`)
  }
  return dirname(pkgRoot)
}

/** Resolves the path to the likec4 app directory (__app__) used by Vite for dev/preview. */
export function viteAppRoot() {
  const pkg = findPkgRoot()
  const roots = [
    resolve(pkg, '__app__'),
    resolve(_dirname, '../__app__'),
    resolve(_dirname, '../../__app__'),
    resolve(_dirname, '../../dist/__app__'),
  ]
  const root = find(roots, existsSync)
  if (!root) {
    rootLogger.error(`likec4 app root does not exist, tried:\n${roots.join('\n')}`)
    throw new Error(`likec4 app root does not exist`)
  }
  return root
}

/** Creates a temporary directory with a placeholder likec4-views.js for Vite publicDir. */
export async function mkTempPublicDir() {
  const publicDir = await mkdtemp(join(tmpdir(), '.likec4-public-'))
  await writeFile(join(publicDir, 'likec4-views.js'), '// generated by likec4\n')
  return publicDir
}

/** Returns the path relative to the current working directory. */
export function relativeToCwd(path: string) {
  return relative(cwd(), path)
}

/**
 * Adjust chunk size warning limit (in kB).
 */
export const chunkSizeWarningLimit = 10_000
